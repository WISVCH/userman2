{% extends "base.html" %}
{% load userman_tags %}
{% block title %}Userman2 â€” Manage Users{% endblock %}
{% load static %}
{% block content %}

{% verbatim %}
<div id="app">
    <table class="table table-striped">
        <thead>
            <tr>    
                <th style="width: 32px;">&nbsp;</th>
                <th>Username</th>
                <th>Full Name</th>
                <th>UID</th>
                <th style="width: 18em;">
                    Dienst2 Status
                    <a v-if="showSyncIcon" href="#" v-on:click.prevent="fetchDienst2Status"><i class="fas fa-sync-alt"></i></a>
                </th>
            </tr>
        </thead>
        <tbody>
            <tr v-for="user in users">
                <td><a v-bind:href="user.name + '/'"><i class="far fa-edit"></i></span></a></td>
                <td>{{ user.name }}</td>
                <td>{{ user.full_name }}</td>
                <td>{{ user.uid }}</td>
                <td v-if="user.dienst2status">
                    <span v-if="user.dienst2status.error">
                        <small>{{ user.dienst2status.error }}</small>
                    </span>
                    <span v-if="user.dienst2status.status == 'error'">
                        <i class="fas fa-times-circle" style="color: red;"></i>
                        <a v-bind:href="'https://dienst2.chnet/ldb/index/#' + user.full_name">{{ user.dienst2status.message }}</a>
                    </span>
                    <span v-if="user.dienst2status.status == 'warning'">
                        <i class="fas fa-exclamation-circle" style="color: orange"></i>
                        <a v-bind:href="user.dienst2status.href">{{ user.dienst2status.message }}</a>
                    </span>
                    <span v-if="user.dienst2status.status == 'success'">
                        <i class="fas fa-check-circle" style="color: green;"></i>
                        <a v-bind:href="user.dienst2status.href">{{ user.dienst2status.message }}</a>
                    </span>
                </td>
                <td v-else></td>
            </tr>
        </tbody>
    </table>
</div>
{% endverbatim %}

<script type="text/javascript">
    const app = new Vue({
        el: '#app',
        data: {
            users: [],
            showSyncIcon: true,
        },
        async created() {
            const response = await fetch('../users.json');
            const users = await response.json();
            this.users = users;
        },
        methods: {
            fetchDienst2Status() {
                this.showSyncIcon = false;
                for (const [i, user] of this.users.entries()) {
                    fetch(user.name + '/dienst2status.json')
                        .then(response => response.json())
                        .then(json => this.$set(this.users[i], 'dienst2status', json));
                }
            }
        }
    })
</script>

{% endblock %}
